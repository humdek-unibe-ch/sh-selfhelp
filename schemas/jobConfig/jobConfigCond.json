{
	"$schema": "http://json-schema.org/draft-04/schema#",
	"definitions": {
		"condition_ref": {
			"type": "object",			
			"options": {
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true,
				"compact": true
			},
			"properties": {
				"jsonLogic": {
					"type": "object",
					"title": "jsonLogic",
					"options": {
						"hidden": true
					}
				},
				"builder": {
					"type": "object",
					"title": "Builder",
					"options": {
						"hidden": true
					}
				},
				"condition_btn": {
					"type": "button",
					"title": "Add condition",					
					"options": {
						"button": {
							"action": "showConditionBuilder"
						},
						"inputAttributes": {
						  "data-container":  "condition-btn",
						  "class": "btn btn-primary btn-sm json-editor-btn-"
						}
					}
				}
			}
		},
		"condition_ref_on_execute": {
			"type": "object",
			"options": {
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true,
				"compact": true
			},
			"properties": {
				"jsonLogic": {
					"type": "object",
					"title": "jsonLogic",
					"options": {
						"hidden": true
					}
				},
				"builder": {
					"type": "object",
					"title": "Builder",
					"options": {
						"hidden": true
					}
				},
				"condition_btn": {
					"type": "button",
					"title": "Add condition on execute",
					"options": {
						"button": {
							"action": "showConditionBuilder"
						},
						"inputAttributes": {
						  "data-container":  "condition-btn",
						  "class": "btn btn-primary btn-sm json-editor-btn-"
						}
					}
				}
			}
		},
		"block_ref": {
			"type": "object",
			"title": "Block",
			"headerTemplate": "{{i}} - {{self.block_name}}",
			"format": "grid-strict",
			"options": {
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true,
				"compact": true
			},
			"properties": {
				"index": {
					"type": "number",
					"options": {
						"hidden": true
					}
				},
				"condition": {
					"title": "Condition",
					"$ref": "#/definitions/condition_ref",
					"options": {
						"grid_columns": 12
					}
				},
				"block_name": {
					"title": "Block name",
					"default": "Block",
					"type": "string",
					"options": {
						"grid_columns": 6
					}
				},
				"show_randomization_count_hidden": {
					"watch": {
						"even_presentation": "root.randomizer.even_presentation",
						"randomize": "root.randomize"
					},
					"template": "{{even_presentation}}-{{randomize}}",
					"options": {
						"hidden": true
					}
				},
				"randomization_count": {
					"type": "number",
					"title": "Randomization count",
					"default": 0,
					"description": "It keeps the state of the randomization count for even presentation.",
					"options": {
						"dependencies": {
							"show_randomization_count_hidden": [
								"true-true"
							]
						},
						"grid_columns": 6
					}
				},
				"jobs": {
					"type": "array",
					"format": "tabs",
					"title": "Jobs",
					"items": {
						"title": "Job",
						"$ref": "#/definitions/job_ref"
					}
				}
			}
		},
		"randomizer_ref": {
			"type": "object",
			"format": "grid-strict",
			"description": "Add randomization options for the blocks",
			"properties": {
				"even_presentation": {
					"type": "boolean",
					"format": "checkbox",
					"title": "Evenly present blocks",
					"description": "When enabled, the blocks will be presented evenly. A count field will be added to each block and it will be used to adjust the ammount of entries. The counter is global per action and not per user.",
					"options": {
						"grid_columns": 6
					}
				},
				"random_elements": {
					"type": "number",
					"title": "Randomly present",
					"minimum": 1,
					"default": 1,
					"description": "Randomly present the selected ammount from the following blocks.",
					"options": {
						"grid_columns": 6
					}
				}
			}
		},
		"repeater_ref": {
			"type": "object",
			"description": "Define repetition of the blocks. It creates a loop where new dates are calculated based on their date to be scheduled. Example: if you schedule a job immediately and it was defined to occur 3 times every day, then 3 jobs will be created. One for now, one for tomorrow the same time and one for the day after tomorrow at the same time",
			"format": "grid-strict",
			"properties": {
				"occurrences": {
					"type": "integer",
					"title": "Occurrences",
					"minimum": 1,
					"default": 1,
					"description": "How many times the blocks should be scheduled.",
					"options": {
						"grid_columns": 3
					}
				},
				"frequency": {
					"type": "string",
					"title": "Repeat every",
					"enum": [
						"day",
						"week",
						"month"
					],
					"options": {
						"grid_columns": 3,
						"enum_titles": [
							"Day",
							"Week",
							"Month"
						]
					},
					"description": "The frequency at which the event repeats."
				},
				"daysOfWeek": {
					"type": "array",
					"title": "Select week days",
					"uniqueItems": true,
					"format": "select2",
					"options": {
						"grid_columns": 6,
						"select2": {
							"tags": true
						},
						"dependencies": {
							"frequency": [
								"week"
							]
						}
					},
					"items": {
						"type": "string",
						"enum": [
							"Monday",
							"Tuesday",
							"Wednesday",
							"Thursday",
							"Friday",
							"Saturday",
							"Sunday"
						]
					},
					"description": "An array of the days of the week on which the event occurs. Only applicable for weekly frequency."
				},
				"daysOfMonth": {
					"type": "array",
					"title": "Select days",
					"format": "select2",
					"uniqueItems": true,
					"options": {
						"grid_columns": 6,
						"select2": {
							"tags": true
						},
						"dependencies": {
							"frequency": [
								"month"
							]
						}
					},
					"items": {
						"type": "integer",
						"enum": [
							1,
							2,
							3,
							4,
							5,
							6,
							7,
							8,
							9,
							10,
							11,
							12,
							13,
							14,
							15,
							16,
							17,
							18,
							19,
							20,
							21,
							22,
							23,
							24,
							25,
							26,
							27,
							28,
							29,
							30,
							31
						]
					},
					"description": "An array of the days of the month on which the event occurs. Only applicable for monthly frequency."
				}
			}
		},
		"schedule_time_reminder_ref": {
			"type": "object",
			"description": "Define how much time after the notification, the reminder will be sent",
			"title": "Reminder schedule time",
			"options": {
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true
			},
			"format": "grid-strict",
			"properties": {
				"send_after": {
					"type": "number",
					"title": "Send after",
					"minimum": 1,
					"default": 1,
					"options": {
						"grid_columns": 6
					}
				},
				"send_after_type": {
					"type": "string",
					"title": "&nbsp;",
					"default": "days",
					"enum": [
						"seconds",
						"minutes",
						"hours",
						"days",
						"weeks",
						"months"
					],
					"options": {
						"grid_columns": 6
					}
				},
				"parent_job_type_hidden": {
					"type": "string",
					"template": "{{job_type}}",
					"watch": {
						"job_type": "job.job_type"
					},
					"options": {
						"hidden": true
					}
				},
				"valid": {
					"type": "number",
					"title": "Valid for",
					"minimum": 1,
					"default": 1,
					"options": {
						"grid_columns": 6,
						"dependencies": {
							"parent_job_type_hidden": [
								"notification_with_reminder_for_diary"
							]
						}
					}
				},
				"valid_type": {
					"type": "string",
					"description": "For how much time the reminder is valid after it was sent",
					"title": " &nbsp;",
					"default": "hours",
					"enum": [
						"seconds",
						"minutes",
						"hours",
						"days",
						"weeks",
						"months"
					],
					"options": {
						"grid_columns": 6,
						"dependencies": {
							"parent_job_type_hidden": [
								"notification_with_reminder_for_diary"
							]
						}
					}
				}
			}
		},
		"schedule_time_ref": {
			"type": "object",
			"title": "Schedule time",
			"options": {
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true
			},
			"required": [
				"send_on_day_at"
			],
			"format": "grid-strict",
			"properties": {
				"job_schedule_types": {
					"type": "string",
					"title": "Schedule type",
					"options": {
						"grid_columns": 12
					},
					"enumSource": [
						{
							"source": [
								{
									"value": "after_period",
									"text": "After time period"
								},
								{
									"value": "after_period_on_day_at_time",
									"text": "After time period on a weekday at given time"
								},
								{
									"value": "immediately",
									"text": "Immediately"
								},
								{
									"value": "on_fixed_datetime",
									"text": "On specific fixed datetime"
								}
							],
							"title": "{{item.text}}",
							"value": "{{item.value}}"
						}
					]
				},
				"send_after": {
					"type": "number",
					"title": "Send after",
					"default": 1,
					"minimum": 1,
					"options": {
						"grid_columns": 4,
						"dependencies": {
							"job_schedule_types": [
								"after_period"
							]
						}
					}
				},
				"send_after_type": {
					"type": "string",
					"title": "&nbsp;",
					"default": "days",
					"enum": [
						"seconds",
						"minutes",
						"hours",
						"days",
						"weeks",
						"months"
					],
					"options": {
						"grid_columns": 4,
						"dependencies": {
							"job_schedule_types": [
								"after_period"
							]
						}
					}
				},
				"send_on": {
					"type": "string",
					"title": "Send on",
					"enumSource": [],
					"options": {
						"grid_columns": 4,
						"dependencies": {
							"job_schedule_types": [
								"after_period_on_day_at_time"
							]
						}
					}
				},
				"send_on_day": {
					"type": "string",
					"title": "&nbsp;",
					"enumSource": [],
					"options": {
						"grid_columns": 4,
						"dependencies": {
							"job_schedule_types": [
								"after_period_on_day_at_time"
							]
						}
					}
				},
				"send_on_day_at": {
					"type": "string",
					"format": "time",
					"title": "at",
					"options": {
						"grid_columns": 4,
						"dependencies": {
							"job_schedule_types": [
								"after_period_on_day_at_time",
								"after_period"
							]
						},
						"inputAttributes": {
							"placeholder": "Enter time"
						},
						"flatpickr": {
							"inlineHideInput": true,
							"wrap": true,
							"allowInput": true,
							"showClearButton": true
						}
					}
				},
				"custom_time": {
					"type": "string",
					"format": "datetime-local",
					"title": "Select date",
					"options": {
						"grid_columns": 12,
						"dependencies": {
							"job_schedule_types": [
								"on_fixed_datetime"
							]
						},
						"inputAttributes": {
							"placeholder": "Enter date"
						},
						"flatpickr": {
							"inlineHideInput": true,
							"wrap": true,
							"time_24hr": true,
							"allowInput": true,
							"showClearButton": true
						}
					}
				}
			}
		},
		"notification_ref": {
			"type": "object",
			"title": "Notification",
			"format": "grid-strict",
			"options": {
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true
			},
			"properties": {
				"notification_types": {
					"type": "string",
					"title": "Notification type",
					"enum": [
						"email",
						"push_notification"
					],
					"default": "email",
					"options": {
						"grid_columns": 12,
						"enum_titles": [
							"Email",
							"Push notification"
						],
						"dependencies": {
							"job_type": [
								"notification",
								"notification_with_reminder",
								"notification_with_reminder_for_diary"
							]
						}
					}
				},
				"redirect_url": {
					"type": "string",
					"title": "Redirect to URL",
					"options": {
						"grid_columns": 6,
						"dependencies": {
							"notification_types": [
								"push_notification"
							]
						}
					}
				},
				"from_email": {
					"type": "string",
					"title": "From email",
					"options": {
						"grid_columns": 6,
						"dependencies": {
							"notification_types": [
								"email"
							]
						}
					}
				},
				"from_name": {
					"type": "string",
					"title": "From name",
					"options": {
						"grid_columns": 6,
						"dependencies": {
							"notification_types": [
								"email"
							]
						}
					}
				},
				"reply_to": {
					"type": "string",
					"title": "Reply to",
					"options": {
						"grid_columns": 6,
						"dependencies": {
							"notification_types": [
								"email"
							]
						}
					}
				},
				"recipient": {
					"type": "string",
					"title": "Send To (recipient)",
					"description": "Use @user for the user who is triggering the action, separate with `;` for emails",
					"options": {
						"grid_columns": 6,
						"dependencies": {
							"notification_types": [
								"push_notification",
								"email"
							]
						}
					}
				},
				"attachments": {
					"type": "array",
					"uniqueItems": true,
					"format": "select2",
					"options": {
						"grid_columns": 12,
						"dependencies": {
							"notification_types": "email"
						},
						"select2": {
							"tags": true
						}
					},
					"title": "Attachments",
					"items": {
						"type": "string",
						"enum": [
							"att1",
							"att2",
							"att3"
						]
					}
				},
				"subject": {
					"type": "string",
					"title": "Subject",
					"options": {
						"grid_columns": 12,
						"dependencies": {
							"notification_types": [
								"push_notification",
								"email"
							]
						}
					}
				},
				"body": {
					"type": "string",
					"format": "markdown",
					"title": "Body",
					"description": "Use @user_name if you want to address the user who trigered the action with their user name",
					"options": {
						"grid_columns": 12,
						"simplemde": {
							"autoDownloadFontAwesome": false,
							"spellChecker": false,
							"renderingConfig": {
								"singleLineBreaks": false
							}
						},
						"dependencies": {
							"notification_types": [
								"push_notification",
								"email"
							]
						}
					}
				}
			}
		},
		"reminder_ref": {
			"type": "object",
			"options": {
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true
			},
			"properties": {
				"form_id": {
					"type": "string",
					"template": "{{reminder_form_id}}",
					"watch": {
						"reminder_form_id": "job.reminder_form_id"
					},
					"options": {
						"hidden": true
					}
				},
				"schedule_time": {
					"$ref": "#/definitions/schedule_time_reminder_ref"
				},
				"notification": {
					"$ref": "#/definitions/notification_ref"
				}
			}
		},
		"job_ref": {
			"type": "object",
			"id": "job",
			"title": "Job",
			"headerTemplate": "{{i}} - {{self.job_name}}",
			"format": "grid-strict",
			"options": {
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true,
				"compact": true
			},
			"properties": {
				"condition": {
					"title": "Condition",
					"$ref": "#/definitions/condition_ref",
					"options": {
						"grid_columns": 6
					}
				},
				"on_job_execute": {
					"type": "object",
					"options": {
						"disable_collapse": true,
						"disable_edit_json": true,
						"disable_properties": true,
						"compact": true,
						"grid_columns": 6
					},
					"properties": {
						"condition": {
							"title": "Condition on job execute",
							"$ref": "#/definitions/condition_ref_on_execute"
						}
					}
				},
				"job_name": {
					"type": "string",
					"title": "Job name",
					"default": "Job",
					"options": {
						"grid_columns": 6
					}
				},
				"job_type": {
					"type": "string",
					"title": "Job type",
					"enum": [
						"add_group",
						"remove_group",
						"notification",
						"notification_with_reminder",
						"notification_with_reminder_for_diary"
					],
					"options": {
						"enum_titles": [
							"Add group",
							"Remove group",
							"Schedule notification",
							"Schedule notification with reminders",
							"Schedule notification with reminders for a diary"
						],
						"grid_columns": 6
					}
				},
				"reminder_form_id": {
					"type": "string",
					"title": "Reminder for",
					"enumSource": [],
					"options": {
						"grid_columns": 12,
						"dependencies": {
							"job_type": [
								"notification_with_reminder",
								"notification_with_reminder_for_diary"
							]
						}
					}
				},
				"schedule_time": {
					"$ref": "#/definitions/schedule_time_ref"
				},
				"job_add_remove_groups": {
					"type": "array",
					"uniqueItems": true,
					"format": "select2",
					"options": {
						"grid_columns": 12,
						"select2": {
							"tags": true
						},
						"dependencies": {
							"job_type": [
								"add_group",
								"remove_group"
							]
						}
					},
					"title": "Group",
					"description": "Select Selfhelp group",
					"items": {
						"type": "string",
						"enum": [
							"group1",
							"group2",
							"group3"
						]
					}
				},
				"notification": {
					"$ref": "#/definitions/notification_ref",
					"options": {
						"dependencies": {
							"job_type": [
								"notification",
								"notification_with_reminder",
								"notification_with_reminder_for_diary"
							]
						}
					}
				},
				"reminders": {
					"type": "array",
					"title": "Reminders",
					"format": "tabs-top",
					"items": {
						"title": "reminder",
						"$ref": "#/definitions/reminder_ref"
					},
					"options": {
						"dependencies": {
							"job_type": [
								"notification_with_reminder",
								"notification_with_reminder_for_diary"
							]
						}
					}
				}
			}
		}
	},
	"title": "Action config",
	"id": "root",
	"type": "object",
	"format": "grid-strict",
	"required": [
		"blocks"
	],
	"options": {
		"disable_properties": true
	},
	"properties": {
		"condition": {
			"title": "Condition",
			"$ref": "#/definitions/condition_ref",
			"options": {
				"grid_columns": 12
			}
		},
		"randomize": {
			"title": "Randomize",
			"type": "boolean",
			"default": false,
			"format": "checkbox",
			"options": {
				"grid_columns": 3
			}
		},
		"repeat": {
			"title": "Repeat",
			"type": "boolean",
			"default": false,
			"format": "checkbox",
			"options": {
				"grid_columns": 3
			}
		},
		"target_groups": {
			"type": "boolean",
			"title": "Target groups",
			"default": false,
			"format": "checkbox",
			"options": {
				"grid_columns": 3
			}
		},
		"overwrite_variables": {
			"type": "boolean",
			"title": "Overwrite variables",
			"default": false,
			"format": "checkbox",
			"options": {
				"grid_columns": 3
			}
		},
		"randomizer": {
			"title": "Randomizer",
			"$ref": "#/definitions/randomizer_ref",
			"options": {
				"dependencies": {
					"randomize": true
				},
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true,
				"grid_columns": 12
			}
		},
		"repeater": {
			"title": "Repeater",
			"$ref": "#/definitions/repeater_ref",
			"options": {
				"dependencies": {
					"repeat": true
				},
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true,
				"grid_columns": 12
			}
		},
		"selected_target_groups": {
			"type": "array",
			"uniqueItems": true,
			"format": "select2",
			"options": {
				"dependencies": {
					"target_groups": true
				},
				"grid_columns": 6
			},
			"title": "Select target groups",
			"description": "All jobs will be executed to all users within the selected groups. Use it carefully.",
			"items": {
				"type": "string",
				"enum": [
					"admin",
					"therapist",
					"subject",
					"test"
				]
			}
		},
		"selected_overwrite_variables": {
			"type": "array",
			"uniqueItems": true,
			"format": "select2",
			"options": {
				"dependencies": {
					"overwrite_variables": true
				},
				"disable_collapse": true,
				"disable_edit_json": true,
				"disable_properties": true,
				"grid_columns": 6
			},
			"title": "Overwrite variables",
			"description": "Select which variables to be overwritten. If a value with the same name is submitted in the form, it will be used to overwrite the selected variable.",
			"items": {
				"type": "string",
				"enum": [
					"send_after",
					"send_after_type",
					"send_on_day_at",
					"custom_time"
				]
			}
		},
		"blocks": {
			"type": "array",
			"title": "Blocks",
			"format": "tabs-top",
			"items": {
				"title": "Block",
				"$ref": "#/definitions/block_ref"
			}
		}
	}
}